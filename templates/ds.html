<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="with=device-width" , initial-scale="1.0">
  <!--helps make the website responsive-->
  <title>CARS</title>
  <link rel="stylesheet" href="/static/css/style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;600;700&family=Rubik+Bubbles&display=swap"
    rel="stylesheet">
  <section class="header">
    <nav>
      <a href="index.html"><img src="/static/assets/logo.png"></a>
      <div class="nav-links">
        <ul>
          <li><a href="https://teamorborb.github.io/CarHub/index.html">HOME</a></li>
          <li><a href="https://teamorborb.github.io/CarHub/about.html">ABOUT</a></li>
          <li><a href="https://teamorborb.github.io/CarHub/inventory.html">INVENTORY</a></li>
          <li><a href=".">DEALERSHIP</a></li>
          <li><a href="https://teamorborb.github.io/CarHub/Quiz.html">QUIZ</a></li>
          <li><a href="https://teamorborb.github.io/CarHub/profile.html">PROFILE</a></li>

        </ul>
      </div>
    </nav>
  </section>
  <style>
    .error {
      color: red;
    }

    .success {
      color: lime;
    }
  </style>
</head>

<body>
  <div class="text-box">
    <h2 style="margin-top: 50px;"><u>YOUR LOCAL DEALERSHIPS</u></h2>
    <div>
      <div id="info-box" class="area">
        <h3>Your location:</h3>
        <div id="location"></div>
      </div>
      <div id="info-box" class="area">
        <h3>Closest dealership</h3>
        <div id="dealership"></div>
      </div>
    </div>
    <button style="margin-top: 5px;" class="button-29" onclick="getLocation()">Find the closest dealership!</button>

    <!--ADD DEALER-->
    <h2 style="margin-top: 50px;"><u>ADD YOUR LOCAL DEALERSHIP</u></h2>
    <form method="POST" action="/dealerships" style="margin-left: auto; margin-right: auto;">
      <h3 id="response-message"></h3>
      <label>Name of the dealership:</label>
      <input type="text" name="name" class="area"><br>
    
      <label>Address of the dealership:</label>
      <input type="text" name="address" class="area"><br>
    
      <label>Latitude of the dealership:</label>
      <input type="text" name="latitude" class="area"><br>
    
      <label>Longitude of the dealership:</label>
      <input type="text" name="longitude" class="area"><br>
    
      <input type="submit" value="Submit" class="button-29" style="margin-top: 5px;">
      <button type="button" onclick="deleteDealership()" class="button-29" style="margin-top: 5px;">Delete Dealership</button>
    </form>
    
    <script>
    function deleteDealership() {
      const dealershipId = // get the dealership ID from somewhere, e.g. a hidden input field in the form
      fetch('/dealerships/' + dealershipId, {
        method: 'DELETE',
      })
      .then(response => {
        if (response.ok) {
          // show success message and/or update UI
        } else {
          // show error message and/or update UI
        }
      })
      .catch(error => {
        console.error('Error:', error);
        // show error message and/or update UI
      });
    }
    </script>
      <script>
            function fetchDealerships() {
              // make a GET request to fetch dealership data
              fetch('/dealerships')
                .then(response => response.json())
                .then(data => {
                  // get the table element
                  const table = document.getElementById('dealerships-table');

                  // add headers to the table
                  const headers = ['Dealership Name', 'Address', 'Longitude', 'Latitude', ''];
                  const headerRow = table.insertRow();
                  for (let i = 0; i < headers.length; i++) {
                    const headerCell = headerRow.insertCell();
                    headerCell.textContent = headers[i];
                  }

                  // add data rows to the table
                  for (let i = 0; i < data.length; i++) {
                    const dealership = data[i];
                    const row = table.insertRow();
                    row.insertCell().textContent = dealership.name;
                    row.insertCell().textContent = dealership.address;
                    row.insertCell().textContent = dealership.longitude;
                    row.insertCell().textContent = dealership.latitude;
                    const editCell = row.insertCell();
                    const editButton = document.createElement('button');
                    editButton.textContent = 'Edit';
                    editButton.addEventListener('click', () => editRow(row));
                    editCell.appendChild(editButton);
                    const deleteCell = row.insertCell();
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Delete';
                    deleteButton.addEventListener('click', () => deleteRow(row));
                    deleteCell.appendChild(deleteButton);
                  }
                })
                .catch(error => console.error(error));
            }

            function editRow(row) {
              // get the input values from the row
              const name = row.cells[0].textContent;
              const address = row.cells[1].textContent;
              const longitude = row.cells[2].textContent;
              const latitude = row.cells[3].textContent;

              // replace the row with input fields
              row.innerHTML = `
                <td><input type="text" value="${name}"></td>
                <td><input type="text" value="${address}"></td>
                <td><input type="text" value="${longitude}"></td>
                <td><input type="text" value="${latitude}"></td>
                <td>
                  <button onclick="saveRow(this.parentNode.parentNode)">Save</button>
                  <button onclick="cancelEdit(this.parentNode.parentNode)">Cancel</button>
                </td>
              `;
            }

            function saveRow(row) {
              // get the input values from the row
              const name = row.cells[0].querySelector('input').value;
              const address = row.cells[1].querySelector('input').value;
              const longitude = row.cells[2].querySelector('input').value;
              const latitude = row.cells[3].querySelector('input').value;

              // make a PUT request to update the dealership
              fetch('/dealerships/' + row.rowIndex, {
                method: 'PUT',
                body: JSON.stringify({ name, address, longitude, latitude }),
                headers: { 'Content-Type': 'application/json' }
              })
                .then(response => response.json())
                .then(data => {
                  // replace the input fields with the updated row data
                  row.innerHTML = `
                    <td>${data.name}</td>
                    <td>${data.address}</td>
                  <td>${data.longitude}</td>
                  <td>${data.latitude}</td>
                  <td>
                    <button onclick="editRow(this.parentNode.parentNode)">Edit</button>
                    <button onclick="deleteRow(this.parentNode.parentNode)">Delete</button>
                  </td>
                `;
              })
              .catch(error => console.error(error));
          }

          function cancelEdit(row) {
            // get the dealership data from the row
            const dealership = {
              name: row.cells[0].querySelector('input').value,
              address: row.cells[1].querySelector('input').value,
              longitude: row.cells[2].querySelector('input').value,
              latitude: row.cells[3].querySelector('input').value,
            };

            // replace the input fields with the original data
            row.innerHTML = `
              <td>${dealership.name}</td>
              <td>${dealership.address}</td>
              <td>${dealership.longitude}</td>
              <td>${dealership.latitude}</td>
              <td>
                <button onclick="editRow(this.parentNode.parentNode)">Edit</button>
                <button onclick="deleteRow(this.parentNode.parentNode)">Delete</button>
              </td>
            `;
          }

          function deleteRow(row) {
            // make a DELETE request to delete the dealership
            fetch('https://example.com/api/dealerships/' + row.rowIndex, {
              method: 'DELETE',
            })
              .then(() => {
                // remove the row from the table
                row.parentNode.removeChild(row);
              })
              .catch(error => console.error(error));
          }

      </script>
    </form>
  </div>
</body>

<script>
  const messageBox = document.getElementById("response-message");

  async function handleSubmit(event) {
    event.preventDefault();

    const formData = new FormData(event.target);

    let userInput = {
      "name": formData.get("name"),
      "address": formData.get("address"),
      "latitude": formData.get("latitude"),
      "longitude": formData.get("longitude"),
    };

    console.table(userInput);

    let URL = event.target.getAttribute("action");
    let response = await fetch(URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(userInput),
    });

    let {message, message_type: messageType} = await response.json();

    console.log(message, messageType);

    messageBox.innerText = message;
    messageBox.className = messageType;
  }

  const form = document.querySelector('form');
  form.addEventListener('submit', handleSubmit);

  // gets the location of the user
  function getLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(showPosition);
    } else {
      document.getElementById("location").innerHTML = "Geolocation is not supported by this browser.";
    }
  }

  function findShortestLocation(userLocation, dealershipLocations) {
    // Calculate the distance between the user's location and each dealership
    let shortestDistance = Infinity
    let nearestDealership = dealershipLocations.pop();

    for (let location of dealershipLocations) {
      let distance = calculateDistance(
        userLocation.latitude,
        userLocation.longitude,
        location.latitude,
        location.longitude,
      );
      // Determine which dealership is closer
      if (distance < shortestDistance) {
        nearestDealership = location;
        shortestDistance = distance;
      }
    }
    // if there is no dealerships, then the will print out this error message. 
    if (!nearestDealership) {
      alert("couldn't find the shortest distance. Possibly due to empty dealership location list");
    }

    return nearestDealership;


  }

  function showPosition(position) {
    document.getElementById("location").innerHTML = "Latitude: " + position.coords.latitude +
      "<br>Longitude: " + position.coords.longitude;


    //let locationsURL = `https://cars.nighthawkcodingsociety.com/dealerships`;
    let locationsURL = `${location.origin}/dealerships`;
    fetch(locationsURL).then(d => d.json()).then(dealershipLocations => {

      // For demo purposes, let's say there are two dealerships
      // located at the following coordinates:
      // var dealership1 = { lat: 33.015200, lng: -117.083380 };
      // var dealership2 = { lat: 34.0522, lng: -118.2437 };
      // if ur close to dealership1, then it will output dealership 1
      // if ur close to dealership2, then it will output dealership 2



      let nearestDealership = findShortestLocation(
        {
          latitude: position.coords.latitude,
          longitude: position.coords.longitude
        },
        dealershipLocations
      );

      document.getElementById("dealership").innerHTML = `
          The nearest dealership is located at:<br />
          Name: ${nearestDealership.name}<br />
          Address: ${nearestDealership.address}<br />
          Latitude: ${nearestDealership.latitude}<br />
          Longitude: ${nearestDealership.longitude}
          `;

    });
  }

  function calculateDistance(lat1, lng1, lat2, lng2) {
    // Haversine formula to calculate the distance between two coordinates
    var radius = 6371; // Earth's radius in kilometers
    var dLat = (lat2 - lat1) * (Math.PI / 180);
    var dLng = (lng2 - lng1) * (Math.PI / 180);
    var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
      Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *
      Math.sin(dLng / 2) * Math.sin(dLng / 2);
    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    var d = radius * c;
    return d;
  }
</script>
</body>

</html>